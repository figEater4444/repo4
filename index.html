<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viswam Edutech | IIT-NEET Examination</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2d7a8a; --bg: #f8f9fa; --header-height: 100px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* Branded Header with Logos */
        .header-main { 
            background: white; padding: 10px 40px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-bottom: 5px solid var(--primary);
        }
        .logo-side { flex: 0 0 160px; height: 80px; display: flex; align-items: center; }
        .logo-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .center-brand { text-align: center; flex: 1; }
        .center-brand h1 { margin: 0; color: var(--primary); font-size: 1.8rem; }

        /* Dashboard UI */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .tab-nav { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    </style>
</head>
<body>

    <header class="header-main">
        <div class="logo-side">
            <img src="https://github.com/figEater4444/repo4/blob/main/IIT_logo.jpeg" alt="IIT-NEET Logo">
        </div
        <div class="center-brand">
            <h1>Academic Management Portal</h1>
            <p style="margin:5px; color:#555;">Quality Education for a Brighter Future</p>
        </div>
        <div class="logo-side" style="justify-content: flex-end;">
            <img src="https://github.com/figEater4444/repo4/blob/main/Viswam_logo.jpeg" alt="Viswam Logo">
        </div>
    </header>

    <div id="loginView" class="container" style="max-width: 400px; margin-top: 60px;">
        <div class="card">
            <h2 style="text-align:center">Secure System Login</h2>
            <form onsubmit="handleAuth(event)">
                <input type="text" id="username" placeholder="User ID" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn-primary" style="width:100%">Sign In</button>
            </form>
            <p id="authErr" style="color:red; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="adminView" class="container hidden">
        <div class="tab-nav">
            <button class="btn-primary" onclick="switchTab('students')">Students</button>
            <button class="btn-primary" onclick="switchTab('create')">Build Exam</button>
            <button class="btn-success" onclick="switchTab('results')">Gradebook</button>
            <button class="btn-danger" onclick="location.reload()">Logout</button>
        </div>

        <div id="tabStudents" class="hidden">
            <div class="card">
                <h3>Create New Student Account</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input type="text" id="newSid" placeholder="ID (e.g. S101)">
                    <input type="password" id="newSpass" placeholder="Password">
                </div>
                <button class="btn-success" onclick="addStudent()">Save Account</button>
            </div>
            <div class="card">
                <h3>Active Students</h3>
                <table id="userTable">
                    <thead><tr><th>Student ID</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="tabCreate" class="hidden">
            <div class="card">
                <h3>Add New MCQ (OCR Enabled)</h3>
                <input type="file" accept="image/*" onchange="extractOCR(this)">
                <textarea id="qBody" placeholder="Question Text..."></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="opt1" placeholder="Option A"> <input type="text" id="opt2" placeholder="Option B">
                    <input type="text" id="opt3" placeholder="Option C"> <input type="text" id="opt4" placeholder="Option D">
                </div>
                <select id="qCorrect">
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                </select>
                <button class="btn-primary" onclick="saveToBank()">Save Question</button>
            </div>
            <div class="card">
                <h3>Assembe & Publish Exam</h3>
                <button class="btn-primary" onclick="loadBank()">Load Question Bank</button>
                <div id="qBankList" style="margin:15px 0; max-height:250px; overflow-y:auto; border:1px solid #eee; padding:10px;"></div>
                <input type="text" id="examSub" placeholder="Subject Name">
                <input type="text" id="examClass" placeholder="Target Class">
                <button class="btn-success" onclick="publishExam()">Publish Now</button>
            </div>
        </div>

        <div id="tabResults" class="hidden">
            <div class="card">
                <h3>Student Results</h3>
                <table id="resTable">
                    <thead><tr><th>Student</th><th>Subject</th><th>Score</th><th>Date</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="studentView" class="container hidden">
        <div id="timer" style="background:#2c3e50; color:white; padding:10px; text-align:center; font-weight:bold; border-radius:8px;">Time: --:--</div>
        <div id="examMain" style="margin-top:20px;"></div>
        <button id="finalSubmit" class="btn-success hidden" onclick="sendSubmission()" style="width:100%; padding:20px; font-size:1.2rem;">Submit Exam</button>
    </div>

    <script>
        const API = '/api';
        let currentUser = {};
        let examQs = [];
        let timerHook;

        // AUTH
        async function handleAuth(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if (u === 'admin' && p === 'Viswam@2026') {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('adminView').classList.remove('hidden');
                switchTab('students');
                return;
            }

            const res = await fetch(API + '/users');
            const users = await res.json();
            const found = users.find(x => x.username === u && x.password === p);

            if (found) {
                currentUser = found;
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('studentView').classList.remove('hidden');
                fetchStudentExams();
            } else {
                document.getElementById('authErr').innerText = "Invalid Access Details";
            }
        }

        // ADMIN: STUDENTS
        async function addStudent() {
            const username = document.getElementById('newSid').value;
            const password = document.getElementById('newSpass').value;
            await fetch(API + '/users', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });
            loadUserList();
            alert("Account Saved");
        }

        async function loadUserList() {
            const res = await fetch(API + '/users');
            const users = await res.json();
            document.querySelector('#userTable tbody').innerHTML = users.map(u => `
                <tr><td>${u.username}</td><td><button class="btn-danger" onclick="delUser('${u.username}')">Delete</button></td></tr>
            `).join('');
        }

        async function delUser(id) {
            if(confirm("Remove student?")) { await fetch(API + '/users/' + id, {method:'DELETE'}); loadUserList(); }
        }

        // EXAM DESIGN
        async function extractOCR(input) {
            const res = await Tesseract.recognize(input.files[0], 'eng');
            document.getElementById('qBody').value = res.data.text;
        }

        async function saveToBank() {
            const q = {
                text: document.getElementById('qBody').value,
                options: {A: document.getElementById('opt1').value, B: document.getElementById('opt2').value, C: document.getElementById('opt3').value, D: document.getElementById('opt4').value},
                correct: document.getElementById('qCorrect').value
            };
            await fetch(API + '/bank', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(q) });
            alert("Added to Bank");
        }

        async function loadBank() {
            const res = await fetch(API + '/bank');
            const data = await res.json();
            document.getElementById('qBankList').innerHTML = data.map(q => `
                <div style="border-bottom:1px solid #eee; padding:8px;">
                    <input type="checkbox" class="q-check" value="${q.id}"> ${q.text.substring(0,80)}...
                </div>
            `).join('');
        }

        async function publishExam() {
            const ids = Array.from(document.querySelectorAll('.q-check:checked')).map(x => parseInt(x.value));
            const bankRes = await fetch(API + '/bank');
            const bank = await bankRes.json();
            const exam = {
                subject: document.getElementById('examSub').value,
                classGrade: document.getElementById('examClass').value,
                questions: bank.filter(q => ids.includes(q.id)),
                duration: 30
            };
            await fetch(API + '/papers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(exam) });
            alert("Exam Live");
        }

        // STUDENT ENGINE
        async function fetchStudentExams() {
            const res = await fetch(API + '/papers');
            const papers = await res.json();
            document.getElementById('examMain').innerHTML = papers.map(p => `
                <div class="card">
                    <h3>${p.subject}</h3>
                    <button class="btn-success" onclick='startExam(${JSON.stringify(p)})'>Begin Test</button>
                </div>
            `).join('');
        }

        function startExam(p) {
            examQs = p.questions.sort(() => Math.random() - 0.5);
            document.getElementById('examMain').innerHTML = examQs.map((q, i) => `
                <div class="card">
                    <p><b>Q${i+1}:</b> ${q.text}</p>
                    ${['A','B','C','D'].map(k => `
                        <label style="display:block; margin:8px 0;"><input type="radio" name="q${i}" value="${k}"> ${q.options[k]}</label>
                    `).join('')}
                </div>
            `).join('');
            document.getElementById('finalSubmit').classList.remove('hidden');
            startClock(p.duration);
        }

        function startClock(m) {
            let s = m * 60;
            timerHook = setInterval(() => {
                document.getElementById('timer').innerText = `Time Left: ${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                if(s-- <= 0) { clearInterval(timerHook); sendSubmission(); }
            }, 1000);
        }

        async function sendSubmission() {
            clearInterval(timerHook);
            let score = 0;
            examQs.forEach((q, i) => {
                if(document.querySelector(`input[name="q${i}"]:checked`)?.value === q.correct) score++;
            });
            await fetch(API + '/submit', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({studentName: currentUser.username, subject: "Exam", score: `${score}/${examQs.length}`})
            });
            document.getElementById('studentView').innerHTML = `<div class="card" style="text-align:center"><h1>Submitted Successfully</h1></div>`;
        }

        // NAVIGATION
        function switchTab(t) {
            ['tabStudents','tabCreate','tabResults'].forEach(x => document.getElementById(x).classList.add('hidden'));
            document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden');
            if(t === 'students') loadUserList();
            if(t === 'results') loadGradebook();
        }

        async function loadGradebook() {
            const res = await fetch(API + '/results');
            const data = await res.json();
            document.querySelector('#resTable tbody').innerHTML = data.map(r => `
                <tr><td>${r.studentName}</td><td>${r.subject}</td><td><b>${r.score}</b></td><td>${r.timestamp}</td></tr>
            `).join('');
        }
    </script>
</body>
</html>
