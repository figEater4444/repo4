<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro MCQ System | Final Version 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --color-primary: #2d7a8a;
            --color-primary-light: #e8f5f7;
            --color-text: #1a1a1a;
            --color-border: #d0d0d0;
            --color-bg: #f4f7f8;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-correct: #d4edda;
            --color-incorrect: #f8d7da;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--color-bg); color: var(--color-text); line-height: 1.6; }
        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

        /* Timer Banner */
        .timer-banner { position: sticky; top: 0; z-index: 1000; background: #2c3e50; color: white; padding: 12px; text-align: center; font-size: 1.2rem; font-weight: bold; }

        /* Modern UI Cards */
        header { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* Form Controls */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; transition: 0.3s; }
        input:focus { border-color: var(--color-primary); outline: none; }
        
        /* Action Buttons */
        .button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-danger { background: var(--color-danger); color: white; }
        .btn-full { width: 100%; }

        /* OCR Drag/Drop Area */
        .ocr-area { border: 2px dashed var(--color-primary); background: var(--color-primary-light); padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 15px; }

        /* Student Question UI */
        .q-block { border-left: 5px solid var(--color-primary); padding-left: 20px; }
        .test-option { display: flex; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
        .test-option:hover { background: #f9f9f9; border-color: #ddd; }
        .test-option input { width: auto; margin-right: 15px; }

        /* Responsive */
        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="container" style="display: flex; justify-content: center; align-items: center; min-height: 100vh;">
        <div class="card" style="width: 100%; max-width: 400px;">
            <h2 style="text-align:center; margin-bottom:25px; color: var(--color-primary);">System Access</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="username" placeholder="e.g. admin or student_name" required>
                </div>
                <div class="form-group">
                    <label>Access Key (Password)</label>
                    <input type="password" id="password" required>
                </div>
                <div id="studentExtra" class="hidden">
                    <div class="form-group"><label>Assigned Class</label><input type="text" id="sClass"></div>
                    <div class="form-group"><label>Exam Subject</label><input type="text" id="sSubject"></div>
                </div>
                <button type="submit" class="button btn-primary btn-full">Sign In</button>
            </form>
        </div>
    </div>

    <div id="adminApp" class="container hidden">
        <header>
            <h1>Academic Management Portal</h1>
            <div style="margin-top:20px; display: flex; gap: 10px; justify-content: center;">
                <button class="button btn-primary" onclick="showTab('creator')">Exam Designer</button>
                <button class="button btn-success" onclick="showTab('results')">Gradebook & Analytics</button>
                <button class="button btn-danger" onclick="logout()">Logout</button>
            </div>
        </header>

        <div id="tabCreator">
            <div class="grid">
                <div class="card">
                    <h3>ðŸ“„ Paper Configuration</h3>
                    <div class="form-group"><label>Subject</label><input type="text" id="paperSubject" placeholder="Mathematics"></div>
                    <div class="form-group"><label>Target Class</label><input type="text" id="paperClass" placeholder="10A"></div>
                    <div class="form-group"><label>Duration (Minutes)</label><input type="number" id="paperDuration" value="30"></div>
                </div>
                <div class="card">
                    <h3>âž• Question Builder</h3>
                    <div class="ocr-area">
                        <label>ðŸ“¸ Screenshot OCR Extract</label>
                        <input type="file" accept="image/*" onchange="performOCR(this)" style="margin-top:10px;">
                        <div id="ocrStatus" style="font-size:0.85rem; margin-top:10px;">Ready for image...</div>
                    </div>
                    <textarea id="qText" placeholder="Edit extracted text or type question here..." style="height:100px; margin-bottom:15px;"></textarea>
                    <div class="grid" style="gap:10px;">
                        <input type="text" id="optA" placeholder="Option A">
                        <input type="text" id="optB" placeholder="Option B">
                        <input type="text" id="optC" placeholder="Option C">
                        <input type="text" id="optD" placeholder="Option D">
                    </div>
                    <div class="form-group" style="margin-top:15px;">
                        <label>Correct Choice</label>
                        <select id="qCorrect">
                            <option value="A">Choice A</option>
                            <option value="B">Choice B</option>
                            <option value="C">Choice C</option>
                            <option value="D">Choice D</option>
                        </select>
                    </div>
                    <button class="button btn-primary btn-full" onclick="commitQuestion()">Save to Database</button>
                </div>
            </div>
        </div>

        <div id="tabResults" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ðŸ“Š Historical Data</h3>
                    <button class="button btn-success" onclick="exportToCSV()">Download CSV</button>
                </div>
                <table id="resultsTable" style="width:100%; border-collapse: collapse;">
                    <thead><tr style="border-bottom: 2px solid #eee;">
                        <th>Student</th><th>Subject</th><th>Score</th><th>Timestamp</th>
                    </tr></thead>
                    <tbody id="resBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="studentApp" class="container hidden">
        <div id="countdown" class="timer-banner">Session Time: --:--</div>
        <header>
            <h2 id="stTitle">Exam in Progress</h2>
            <p id="stDetails" style="color: #666;"></p>
        </header>
        <div id="paperBody"></div>
        <button id="submitExam" class="button btn-success btn-full" onclick="processSubmission()" style="margin-top:30px; padding: 25px; font-size: 1.2rem;">Finalize and Submit</button>
    </div>

    <script>
        // --- DATABASE LOGIC ---
        let db;
        const dbReq = indexedDB.open('PRO_EXAM_SYSTEM', 3);
        dbReq.onupgradeneeded = (e) => {
            const d = e.target.result;
            if(!d.objectStoreNames.contains('papers')) d.createObjectStore('papers', { keyPath: 'id', autoIncrement: true }).createIndex('f', ['subject', 'classGrade']);
            if(!d.objectStoreNames.contains('questions')) d.createObjectStore('questions', { keyPath: 'id', autoIncrement: true }).createIndex('pId', 'paperId');
            if(!d.objectStoreNames.contains('results')) d.createObjectStore('results', { keyPath: 'id', autoIncrement: true });
        };
        dbReq.onsuccess = (e) => db = e.target.result;

        let userCtx = {};
        let activeQs = [];
        let timerHook;

        // --- AUTHENTICATION ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            if(u === 'admin') {
                userCtx = { role: 'admin' };
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminApp').classList.remove('hidden');
            } else {
                userCtx = { 
                    role: 'student', 
                    name: u,
                    class: document.getElementById('sClass').value,
                    subject: document.getElementById('sSubject').value
                };
                launchStudentPortal();
            }
        }

        // --- ADMIN FEATURES ---
        async function performOCR(input) {
            const status = document.getElementById('ocrStatus');
            status.innerHTML = "ðŸŒ€ <b>Extracting text...</b>";
            try {
                const res = await Tesseract.recognize(input.files[0], 'eng');
                document.getElementById('qText').value = res.data.text;
                status.innerHTML = "âœ… Extraction successful!";
            } catch (err) { status.innerHTML = "âŒ OCR Failed."; }
        }

        function commitQuestion() {
            const paper = {
                subject: document.getElementById('paperSubject').value,
                classGrade: document.getElementById('paperClass').value,
                duration: document.getElementById('paperDuration').value
            };
            const tx = db.transaction(['papers', 'questions'], 'readwrite');
            tx.objectStore('papers').add(paper).onsuccess = (ev) => {
                const q = {
                    paperId: ev.target.result,
                    text: document.getElementById('qText').value,
                    options: { 
                        A: document.getElementById('optA').value, B: document.getElementById('optB').value,
                        C: document.getElementById('optC').value, D: document.getElementById('optD').value
                    },
                    correct: document.getElementById('qCorrect').value
                };
                tx.objectStore('questions').add(q);
                alert("Saved to Question Bank.");
            };
        }

        // --- STUDENT FEATURES ---
        function launchStudentPortal() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentApp').classList.remove('hidden');
            
            const tx = db.transaction(['papers', 'questions'], 'readonly');
            tx.objectStore('papers').index('f').get([userCtx.subject, userCtx.class]).onsuccess = (e) => {
                const p = e.target.result;
                if(!p) return alert("Paper Not Found.");
                
                document.getElementById('stDetails').innerText = `Candidate: ${userCtx.name} | Subject: ${p.subject}`;
                
                tx.objectStore('questions').index('pId').getAll(p.id).onsuccess = (ev) => {
                    let questions = ev.target.result;
                    // FISHER-YATES SHUFFLE
                    for (let i = questions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [questions[i], questions[j]] = [questions[j], questions[i]];
                    }
                    activeQs = questions;
                    buildPaper();
                    startClock(p.duration);
                };
            };
        }

        function buildPaper() {
            const body = document.getElementById('paperBody');
            body.innerHTML = activeQs.map((q, i) => {
                // SCRAMBLE OPTION KEYS
                const keys = ['A','B','C','D'].sort(() => Math.random() - 0.5);
                return `
                <div class="card q-block">
                    <p><b>Q${i+1}.</b> ${q.text}</p>
                    <div style="margin-top:15px;">
                        ${keys.map(k => `
                            <label class="test-option">
                                <input type="radio" name="q${i}" value="${k}"> <span>${q.options[k]}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function startClock(m) {
            let s = m * 60;
            timerHook = setInterval(() => {
                const mins = Math.floor(s/60);
                const secs = s%60;
                document.getElementById('countdown').innerText = `Session Time: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
                if(s <= 0) { clearInterval(timerHook); processSubmission(); }
                s--;
            }, 1000);
        }

        function processSubmission() {
            clearInterval(timerHook);
            let score = 0;
            activeQs.forEach((q, i) => {
                const choice = document.querySelector(`input[name="q${i}"]:checked`)?.value;
                if(choice === q.correct) score++;
            });

            db.transaction('results', 'readwrite').objectStore('results').add({
                student: userCtx.name,
                subject: userCtx.subject,
                score: `${score}/${activeQs.length}`,
                ts: new Date().toLocaleString()
            });

            document.getElementById('paperBody').innerHTML = `<div class="card" style="text-align:center"><h2>Submission Successful</h2><p style="font-size:2.5rem; color:var(--color-primary);">${score} / ${activeQs.length}</p></div>`;
            document.getElementById('submitExam').classList.add('hidden');
        }

        // --- UTILS ---
        function showTab(t) {
            document.getElementById('tabCreator').classList.toggle('hidden', t !== 'creator');
            document.getElementById('tabResults').classList.toggle('hidden', t !== 'results');
            if(t === 'results') refreshResults();
        }

        function refreshResults() {
            db.transaction('results').objectStore('results').getAll().onsuccess = (e) => {
                document.getElementById('resBody').innerHTML = e.target.result.map(r => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding:12px;">${r.student}</td><td>${r.subject}</td><td><b>${r.score}</b></td><td>${r.ts}</td>
                    </tr>
                `).join('');
            };
        }

        function exportToCSV() {
            db.transaction('results').objectStore('results').getAll().onsuccess = (e) => {
                let csv = "Student,Subject,Score,Timestamp\n";
                e.target.result.forEach(r => csv += `${r.student},${r.subject},${r.score},${r.ts}\n`);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', 'Exam_Results_2026.csv');
                a.click();
            };
        }

        function logout() { location.reload(); }
        document.getElementById('username').addEventListener('input', (e) => {
            document.getElementById('studentExtra').classList.toggle('hidden', e.target.value === 'admin');
        });
    </script>
</body>
</html>
