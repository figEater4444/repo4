<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viswam Edutech | IIT-NEET Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2d7a8a; --bg: #f4f7f8; --dark: #34495e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Branded Title Bar */
        .title-bar { 
            background: white; padding: 15px 30px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary);
        }
        .logo-box { flex: 0 0 180px; }
        .logo-box img { max-width: 100%; max-height: 70px; object-fit: contain; }
        .title-text { text-align: center; flex-grow: 1; color: var(--primary); }

        /* General UI */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .nav-row { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .timer { background: var(--dark); color: white; text-align: center; padding: 10px; font-weight: bold; border-radius: 8px; position: sticky; top: 0; }
    </style>
</head>
<body>

    <header class="title-bar no-print">
        <div class="logo-box">
            <img src="iitneet.png" alt="IIT-NEET Logo">
        </div>
        <div class="title-text">
            <h1 style="margin:0;">Academic Management Portal</h1>
            <p style="margin:5px 0 0 0; color:#666;">Empowering Future Achievers</p>
        </div>
        <div class="logo-box" style="text-align: right;">
            <img src="viswam.png" alt="Viswam Logo">
        </div>
    </header>

    <div id="loginView" class="container" style="max-width: 400px; margin-top: 50px;">
        <div class="card">
            <h2 style="text-align:center; color: var(--primary);">Secure Login</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="User ID" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn-primary" style="width:100%">Sign In</button>
            </form>
            <p id="loginErr" style="color:red; text-align:center;"></p>
        </div>
    </div>

    <div id="adminView" class="container hidden">
        <div class="nav-row">
            <button class="btn-primary" onclick="showTab('students')">Students</button>
            <button class="btn-primary" onclick="showTab('create')">Design Exam</button>
            <button class="btn-success" onclick="showTab('results')">Gradebook</button>
            <button class="btn-danger" onclick="location.reload()">Logout</button>
        </div>

        <div id="tabStudents" class="hidden">
            <div class="card">
                <h3>Create Student Account</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input type="text" id="newUserId" placeholder="Student ID">
                    <input type="password" id="newUserPass" placeholder="Password">
                </div>
                <button class="btn-success" onclick="createStudent()">Save Student</button>
            </div>
            <div class="card">
                <h3>Registered Student List</h3>
                <table id="studentTable">
                    <thead><tr><th>ID</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="tabCreate" class="hidden">
            <div class="card">
                <h3>Add Question (OCR Active)</h3>
                <input type="file" accept="image/*" onchange="runOCR(this)">
                <textarea id="qText" placeholder="Question content..."></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="optA" placeholder="Option A"> <input type="text" id="optB" placeholder="Option B">
                    <input type="text" id="optC" placeholder="Option C"> <input type="text" id="optD" placeholder="Option D">
                </div>
                <select id="qCorrect">
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                </select>
                <input type="text" id="qSubj" placeholder="Subject/Topic">
                <button class="btn-primary" onclick="saveToBank()">Add to Bank</button>
            </div>
            <div class="card">
                <h3>Assemble Paper</h3>
                <button class="btn-primary" onclick="fetchBank()">Load Bank</button>
                <div id="bankList" style="margin:15px 0; max-height:200px; overflow-y:auto; border:1px solid #eee;"></div>
                <input type="text" id="pTitle" placeholder="Exam Title">
                <input type="text" id="pTarget" placeholder="Target Class">
                <button class="btn-success" onclick="publishExam()">Publish Paper</button>
            </div>
        </div>

        <div id="tabResults" class="hidden">
            <div class="card">
                <h3>Student Gradebook</h3>
                <table id="resTable">
                    <thead><tr><th>Name</th><th>Subject</th><th>Score</th><th>Date</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="studentView" class="container hidden">
        <div id="timer" class="timer">Time Remaining: --:--</div>
        <div id="examBody" style="margin-top:20px;"></div>
        <button id="submitBtn" class="btn-success hidden" onclick="finalizeExam()" style="width:100%; padding:20px; font-size:1.2rem;">Submit Exam</button>
    </div>

    <script>
        const API = '/api';
        let currentUser = {};
        let activeQs = [];
        let clock;

        // AUTH
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if (u === 'admin' && p === 'Viswam@2026') {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('adminView').classList.remove('hidden');
                showTab('students');
                return;
            }

            const res = await fetch(API + '/users');
            const users = await res.json();
            const student = users.find(x => x.username === u && x.password === p);

            if (student) {
                currentUser = student;
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('studentView').classList.remove('hidden');
                loadStudentExams();
            } else {
                document.getElementById('loginErr').innerText = "âŒ Invalid Credentials";
            }
        }

        // STUDENT ADMIN
        async function createStudent() {
            const username = document.getElementById('newUserId').value;
            const password = document.getElementById('newUserPass').value;
            const res = await fetch(API + '/users', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });
            if (res.ok) { loadStudents(); alert("Student Account Created"); }
            else alert("Error: ID exists");
        }

        async function loadStudents() {
            const res = await fetch(API + '/users');
            const users = await res.json();
            document.querySelector('#studentTable tbody').innerHTML = users.map(u => `
                <tr><td>${u.username}</td><td><button class="btn-danger" onclick="delStudent('${u.username}')">Delete</button></td></tr>
            `).join('');
        }

        async function delStudent(id) {
            if(confirm("Delete student?")) { await fetch(API + '/users/' + id, {method:'DELETE'}); loadStudents(); }
        }

        // BANK & EXAM
        async function runOCR(input) {
            const res = await Tesseract.recognize(input.files[0], 'eng');
            document.getElementById('qText').value = res.data.text;
        }

        async function saveToBank() {
            const q = {
                text: document.getElementById('qText').value,
                options: {A: document.getElementById('optA').value, B: document.getElementById('optB').value, C: document.getElementById('optC').value, D: document.getElementById('optD').value},
                correct: document.getElementById('qCorrect').value,
                subject: document.getElementById('qSubj').value
            };
            await fetch(API + '/bank', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(q) });
            alert("Added to Global Bank");
        }

        async function fetchBank() {
            const res = await fetch(API + '/bank');
            const data = await res.json();
            document.getElementById('bankList').innerHTML = data.map(q => `
                <div style="padding:10px; border-bottom:1px solid #eee;">
                    <input type="checkbox" class="q-pick" value="${q.id}"> [${q.subject}] ${q.text.substring(0,60)}...
                </div>
            `).join('');
        }

        async function publishExam() {
            const ids = Array.from(document.querySelectorAll('.q-pick:checked')).map(x => parseInt(x.value));
            const bankRes = await fetch(API + '/bank');
            const bank = await bankRes.json();
            const exam = {
                subject: document.getElementById('pTitle').value,
                classGrade: document.getElementById('pTarget').value,
                questions: bank.filter(q => ids.includes(q.id)),
                duration: 30
            };
            await fetch(API + '/papers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(exam) });
            alert("Exam Published Successfully");
        }

        // EXAM ENGINE
        async function loadStudentExams() {
            const res = await fetch(API + '/papers');
            const papers = await res.json();
            document.getElementById('examBody').innerHTML = papers.map(p => `
                <div class="card">
                    <h3>${p.subject} Final Exam</h3>
                    <button class="btn-success" onclick='startExam(${JSON.stringify(p)})'>Start Test</button>
                </div>
            `).join('');
        }

        function startExam(p) {
            activeQs = p.questions.sort(() => Math.random() - 0.5);
            document.getElementById('examBody').innerHTML = activeQs.map((q, i) => `
                <div class="card">
                    <p><b>Q${i+1}:</b> ${q.text}</p>
                    ${['A','B','C','D'].map(k => `
                        <label style="display:block; margin:10px 0;"><input type="radio" name="q${i}" value="${k}"> ${q.options[k]}</label>
                    `).join('')}
                </div>
            `).join('');
            document.getElementById('submitBtn').classList.remove('hidden');
            startTimer(p.duration);
        }

        function startTimer(m) {
            let s = m * 60;
            clock = setInterval(() => {
                document.getElementById('timer').innerText = `Time Remaining: ${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                if(s-- <= 0) { clearInterval(clock); finalizeExam(); }
            }, 1000);
        }

        async function finalizeExam() {
            clearInterval(clock);
            let score = 0;
            activeQs.forEach((q, i) => {
                const choice = document.querySelector(`input[name="q${i}"]:checked`)?.value;
                if(choice === q.correct) score++;
            });
            await fetch(API + '/submit', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({studentName: currentUser.username, subject: "Final", score: `${score}/${activeQs.length}`})
            });
            document.getElementById('studentView').innerHTML = `
                <div class="card" style="text-align:center">
                    <h1>Test Completed</h1>
                    <h2 style="color:var(--primary)">Score: ${score} / ${activeQs.length}</h2>
                </div>`;
        }

        // TABS
        function showTab(t) {
            ['tabStudents','tabCreate','tabResults'].forEach(x => document.getElementById(x).classList.add('hidden'));
            document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden');
            if(t === 'students') loadStudents();
            if(t === 'results') loadResults();
        }

        async function loadResults() {
            const res = await fetch(API + '/results');
            const data = await res.json();
            document.querySelector('#resTable tbody').innerHTML = data.map(r => `
                <tr><td>${r.studentName}</td><td>${r.subject}</td><td><b>${r.score}</b></td><td>${r.timestamp}</td></tr>
            `).join('');
        }
    </script>
</body>
</html>
