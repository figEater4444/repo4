<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro MCQ System | Question Bank & Selection</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --color-primary: #2d7a8a;
            --color-primary-light: #e8f5f7;
            --color-text: #1a1a1a;
            --color-border: #d0d0d0;
            --color-bg: #f4f7f8;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--color-bg); color: var(--color-text); line-height: 1.6; }
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* UI Elements */
        header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-success { background: var(--color-success); color: white; }
        .btn-danger { background: var(--color-danger); color: white; }
        
        /* Question Bank List */
        .q-bank-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; align-items: flex-start; gap: 15px; }
        .q-bank-item:last-child { border: none; }
        .q-content { flex-grow: 1; }
        .q-options-preview { font-size: 0.85rem; color: #666; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }

        /* Print Optimization */
        @media print {
            .no-print { display: none !important; }
            .container { width: 100%; max-width: none; margin: 0; padding: 0; }
            .card { box-shadow: none; border: none; }
        }

        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="container" style="display: flex; justify-content: center; align-items: center; min-height: 100vh;">
        <div class="card" style="width: 100%; max-width: 400px;">
            <h2 style="text-align:center; margin-bottom:20px; color: var(--color-primary);">Exam Portal</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="Username (admin for teacher)" required style="margin-bottom:10px; width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;">
                <input type="password" id="password" required style="margin-bottom:15px; width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;">
                <div id="studentExtra" class="hidden">
                    <input type="text" id="sClass" placeholder="Class" style="margin-bottom:10px; width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;">
                    <input type="text" id="sSubject" placeholder="Subject" style="margin-bottom:10px; width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;">
                </div>
                <button type="submit" class="button btn-primary" style="width:100%;">Sign In</button>
            </form>
        </div>
    </div>

    <div id="adminApp" class="container hidden">
        <header class="no-print">
            <h1>Teacher Dashboard</h1>
            <div style="margin-top:15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="button btn-primary" onclick="showTab('add')">Add New Question</button>
                <button class="button btn-primary" onclick="showTab('bank')">Question Bank</button>
                <button class="button btn-success" onclick="showTab('results')">Gradebook</button>
                <button class="button btn-danger" onclick="logout()">Logout</button>
            </div>
        </header>

        <div id="tabAdd" class="card">
            <h3>üìù Create New Question</h3>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <label>üì∏ OCR From Image</label>
                <input type="file" accept="image/*" onchange="runOCR(this)">
                <p id="ocrStatus" style="font-size:0.8rem; color:var(--color-primary);"></p>
            </div>
            <textarea id="qText" placeholder="Question text..." style="width:100%; height:80px; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
            <div class="grid">
                <input type="text" id="optA" placeholder="Option A">
                <input type="text" id="optB" placeholder="Option B">
                <input type="text" id="optC" placeholder="Option C">
                <input type="text" id="optD" placeholder="Option D">
            </div>
            <div style="margin-top:10px;">
                <label>Correct Answer:</label>
                <select id="qCorrect"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                <input type="text" id="qSubject" placeholder="Subject Category" style="width:200px; margin-left:10px; padding:5px;">
            </div>
            <button class="button btn-primary" style="margin-top:15px;" onclick="saveToBank()">Save to Question Bank</button>
        </div>

        <div id="tabBank" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <h3>üìã Global Question Bank</h3>
                    <button class="button btn-success" onclick="createPaperFromSelected()">Create Paper from Selected</button>
                </div>
                <div id="bankList" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="tabResults" class="hidden">
            <div class="card">
                <h3>üìä Student Results</h3>
                <table id="resTable" style="width:100%; margin-top:15px;">
                    <thead><tr><th>Student</th><th>Subject</th><th>Score</th><th>Date</th></tr></thead>
                    <tbody id="resBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="studentApp" class="container hidden">
        <div id="timer" style="background:#2c3e50; color:white; padding:10px; text-align:center; font-weight:bold; position:sticky; top:0;">Time Left: --:--</div>
        <div id="examBody" style="margin-top:20px;"></div>
        <button id="submitExam" class="button btn-success" onclick="submitExam()" style="width:100%; margin-top:20px; padding:15px;">Submit Exam</button>
    </div>

    <script>
        let db;
        const req = indexedDB.open('MCQ_SYSTEM_V4', 1);
        req.onupgradeneeded = (e) => {
            const d = e.target.result;
            d.createObjectStore('bank', { keyPath: 'id', autoIncrement: true });
            d.createObjectStore('papers', { keyPath: 'id', autoIncrement: true }).createIndex('f', ['subject', 'classGrade']);
            d.createObjectStore('results', { keyPath: 'id', autoIncrement: true });
        };
        req.onsuccess = (e) => db = e.target.result;

        let user = {};
        let paperQs = [];
        let timer;

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            if(u === 'admin') {
                user = {role:'admin'};
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminApp').classList.remove('hidden');
            } else {
                user = {role:'student', name: u, class: document.getElementById('sClass').value, subject: document.getElementById('sSubject').value};
                startStudentMode();
            }
        }

        async function runOCR(input) {
            const status = document.getElementById('ocrStatus');
            status.innerText = "‚è≥ Extracting text...";
            const res = await Tesseract.recognize(input.files[0], 'eng');
            document.getElementById('qText').value = res.data.text;
            status.innerText = "‚úÖ Done!";
        }

        function saveToBank() {
            const q = {
                text: document.getElementById('qText').value,
                subject: document.getElementById('qSubject').value,
                options: {A: document.getElementById('optA').value, B: document.getElementById('optB').value, C: document.getElementById('optC').value, D: document.getElementById('optD').value},
                correct: document.getElementById('qCorrect').value
            };
            db.transaction('bank', 'readwrite').objectStore('bank').add(q).onsuccess = () => {
                alert("Question saved to global bank.");
                showTab('bank');
            };
        }

        function showTab(tab) {
            ['tabAdd', 'tabBank', 'tabResults'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            if(tab === 'bank') loadBank();
            if(tab === 'results') loadResults();
        }

        function loadBank() {
            const list = document.getElementById('bankList');
            db.transaction('bank').objectStore('bank').getAll().onsuccess = (e) => {
                list.innerHTML = e.target.result.map(q => `
                    <div class="q-bank-item">
                        <input type="checkbox" class="bank-selector" data-id="${q.id}">
                        <div class="q-content">
                            <strong>[${q.subject || 'General'}]</strong> ${q.text}
                            <div class="q-options-preview">
                                <span>A: ${q.options.A}</span> <span>B: ${q.options.B}</span>
                                <span>C: ${q.options.C}</span> <span>D: ${q.options.D}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            };
        }

        function createPaperFromSelected() {
            const selected = Array.from(document.querySelectorAll('.bank-selector:checked')).map(el => parseInt(el.dataset.id));
            if(selected.length === 0) return alert("Select at least one question.");
            
            const subject = prompt("Enter Subject for this paper:");
            const targetClass = prompt("Enter Target Class:");
            
            db.transaction('bank').objectStore('bank').getAll().onsuccess = (e) => {
                const qs = e.target.result.filter(q => selected.includes(q.id));
                const paper = { subject, classGrade: targetClass, questions: qs, duration: 30 };
                db.transaction('papers', 'readwrite').objectStore('papers').add(paper).onsuccess = () => {
                    alert("Paper assembled and live for students!");
                };
            };
        }

        function startStudentMode() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentApp').classList.remove('hidden');
            db.transaction('papers').objectStore('papers').index('f').get([user.subject, user.class]).onsuccess = (e) => {
                const p = e.target.result;
                if(!p) return alert("No exam found.");
                paperQs = p.questions.sort(() => Math.random() - 0.5); // Randomize
                document.getElementById('examBody').innerHTML = paperQs.map((q, i) => `
                    <div class="card">
                        <p><strong>Q${i+1}:</strong> ${q.text}</p>
                        ${['A','B','C','D'].sort(() => Math.random()-0.5).map(k => `
                            <label style="display:block; margin:5px 0;"><input type="radio" name="q${i}" value="${k}"> ${q.options[k]}</label>
                        `).join('')}
                    </div>
                `).join('');
                startTimer(p.duration);
            };
        }

        function startTimer(m) {
            let s = m * 60;
            timer = setInterval(() => {
                document.getElementById('timer').innerText = `Time Left: ${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                if(s-- <= 0) { clearInterval(timer); submitExam(); }
            }, 1000);
        }

        function submitExam() {
            clearInterval(timer);
            let score = 0;
            paperQs.forEach((q, i) => {
                if(document.querySelector(`input[name="q${i}"]:checked`)?.value === q.correct) score++;
            });
            db.transaction('results', 'readwrite').objectStore('results').add({name: user.name, subject: user.subject, score: `${score}/${paperQs.length}`, date: new Date().toLocaleDateString()});
            document.getElementById('examBody').innerHTML = `<h2>Exam Complete! Your Score: ${score}/${paperQs.length}</h2>`;
            document.getElementById('submitExam').classList.add('hidden');
        }

        function loadResults() {
            db.transaction('results').objectStore('results').getAll().onsuccess = (e) => {
                document.getElementById('resBody').innerHTML = e.target.result.map(r => `
                    <tr><td>${r.name}</td><td>${r.subject}</td><td>${r.score}</td><td>${r.date}</td></tr>
                `).join('');
            };
        }

        function logout() { location.reload(); }
        document.getElementById('username').addEventListener('input', (e) => {
            document.getElementById('studentExtra').classList.toggle('hidden', e.target.value === 'admin');
        });
    </script>
</body>
</html>
